trigger:
- main

pool:
  vmImage: ubuntu-latest

stages:
# Stage 1: Terraform infra
- stage: DeployInfrastructure
  displayName: 'Deploy Terraform Infrastructure'
  jobs:
  - job: Terraform
    displayName: 'Run Terraform Apply'
    steps:
    - task: TerraformInstaller@1
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: 'latest'
    - task: TerraformTaskV4@4
      displayName: 'Terraform init'
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: 'Dev-Portal'
        backendAzureRmResourceGroupName: 'low'
        backendAzureRmStorageAccountName: 'youruniquestorageaccountname' # <-- CHANGE THIS
        backendAzureRmContainerName: 'tfstate'
        backendAzureRmKey: 'portfolio.tfstate'
    - task: TerraformTaskV4@4
      displayName: 'Terraform apply'
      inputs:
        provider: 'azurerm'
        command: 'apply'
        commandOptions: '-auto-approve'
        environmentServiceNameAzureRM: 'Dev-Portal'

# Stage 2: Build and Push container
- stage: BuildAndPush
  displayName: 'Build and Push Image'
  dependsOn: DeployInfrastructure
  jobs:
  - job: Docker
    displayName: 'Build and Push'
    steps:
    # This task uses the main Azure connection to get admin credentials and log in
    - task: Docker@2
      displayName: 'Login to ACR'
      inputs:
        command: 'login'
        azureSubscription: 'Dev-Portal'
        azureContainerRegistry: 'portfolioregistrytf020qrb'

    - task: Docker@2
      displayName: 'Build and Push Image to ACR'
      inputs:
        command: 'buildAndPush'
        repository: 'portfolio-site'
        dockerfile: '**/Dockerfile'
        tags: 'latest'